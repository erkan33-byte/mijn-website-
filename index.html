<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>BTC Key Generator + WIF + Saldo + Totaal</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/elliptic/6.5.4/elliptic.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; font-size: 14px; word-break: break-all; }
    th { background: #f2f2f2; }
    button, select { margin-bottom: 10px; padding: 8px 12px; }
    #totaal { margin-bottom: 10px; font-weight: bold; }
    #retryMsg { margin-top: 15px; font-weight: bold; color: red; }
  </style>
</head>
<body>
  <h2>BTC Key Generator (met WIF + Saldo, max 500 zichtbaar)</h2>
  <div id="totaal">Totaal gescande adressen: 0</div>

  <label for="speedSelect">Snelheid: </label>
  <select id="speedSelect">
    <option value="1000">1 adres/sec</option>
    <option value="500">2 adressen/sec</option>
    <option value="200">5 adressen/sec</option>
    <option value="100">10 adressen/sec</option>
  </select>
  <br>

  <button id="startBtn">Start zoeken</button>
  <button id="stopBtn" disabled>Stop</button>
  <button onclick="resetTeller()">Reset teller</button>
  <div id="retryMsg"></div>

  <table id="resultTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Adres</th>
        <th>Private Key (WIF)</th>
        <th>Saldo (BTC)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    function toHex(bytes) {
      return Array.from(bytes).map(b => b.toString(16).padStart(2,"0")).join("");
    }

    function hexToBytes(hex) {
      const out = new Uint8Array(hex.length/2);
      for(let i=0;i<out.length;i++) out[i]=parseInt(hex.substr(i*2,2),16);
      return out;
    }

    function sha256Hex(hex) { return CryptoJS.SHA256(CryptoJS.enc.Hex.parse(hex)).toString(); }
    function doubleSha256Hex(hex) { return sha256Hex(sha256Hex(hex)); }

    function base58Encode(hex) {
      const alphabet="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";
      const bytes=hexToBytes(hex);
      let zeros=0;
      while(zeros<bytes.length && bytes[zeros]===0) zeros++;
      let num=BigInt("0x"+hex);
      let out="";
      while(num>0n){let r=num%58n; num/=58n; out=alphabet[Number(r)]+out;}
      return "1".repeat(zeros)+(out||"");
    }

    let counter = 0;
    let totaal = parseInt(localStorage.getItem("totaal") || "0", 10);
    let zoeken = false;
    const MAX_VISIBLE = 500;
    let delay = 1000; // standaard 1/sec

    document.getElementById("totaal").textContent = "Totaal gescande adressen: " + totaal;

    document.getElementById("speedSelect").addEventListener("change", (e) => {
      delay = parseInt(e.target.value, 10);
    });

    // -------- Balance check met fallback APIâ€™s --------
    async function checkBalance(address) {
      const apis = [
        `https://corsproxy.io/?url=https://blockstream.info/api/address/${address}`,
        `https://corsproxy.io/?url=https://mempool.space/api/address/${address}`,
        `https://corsproxy.io/?url=https://blockchain.info/rawaddr/${address}?cors=true`
      ];

      for (let url of apis) {
        try {
          const resp = await fetch(url);
          if (!resp.ok) continue;
          const data = await resp.json();

          // Blockstream & Mempool
          if (data.chain_stats) {
            const funded = Number(data.chain_stats.funded_txo_sum || 0);
            const spent  = Number(data.chain_stats.spent_txo_sum || 0);
            return (funded - spent) / 1e8;
          }

          // Blockchain.info
          if (typeof data.final_balance !== "undefined") {
            return data.final_balance / 1e8;
          }
        } catch (e) {
          continue;
        }
      }
      return "Error";
    }

    // -------- Retry wrapper: blijf proberen tot succes --------
    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    async function checkBalanceUntilOk(address){
      let attempt = 0;
      let wait = 2000;        // start 2s
      const maxWait = 15000;  // max 15s

      while (zoeken) {
        const saldo = await checkBalance(address);
        if (saldo !== "Error") {
          document.getElementById("retryMsg").textContent = "";
          return saldo;
        }
        attempt++;
        document.getElementById("retryMsg").textContent =
          `Saldo-check mislukt (poging ${attempt}). Opnieuw proberen over ${(wait/1000)|0}s...`;
        await sleep(wait);
        wait = Math.min(Math.floor(wait * 1.5), maxWait); // backoff
      }
      return "Aborted"; // als user stopt
    }

    // -------- Generator --------
    async function genereer() {
      if (!zoeken) return;

      // 1) Genereer keypair & adres
      const ec = new elliptic.ec("secp256k1");
      const kp = ec.genKeyPair();

      const pubCompressed = kp.getPublic(true,"array");
      const pubHex = toHex(pubCompressed);
      const sha = sha256Hex(pubHex);
      const ripemd = CryptoJS.RIPEMD160(CryptoJS.enc.Hex.parse(sha)).toString();

      const payload = "00"+ripemd;
      const checksum = doubleSha256Hex(payload).slice(0,8);
      const address = base58Encode(payload+checksum);

      const privHex = kp.getPrivate("hex").padStart(64,"0");
      const wifPayload = "80"+privHex+"01";
      const wifChecksum = doubleSha256Hex(wifPayload).slice(0,8);
      const wif = base58Encode(wifPayload+wifChecksum);

      // 2) Blijf proberen tot saldo-check slaagt
      const saldo = await checkBalanceUntilOk(address);
      if (saldo === "Aborted") return; // user stopte

      // 3) Pas nu tellers + row toevoegen
      counter++;
      totaal++;
      localStorage.setItem("totaal", totaal);
      document.getElementById("totaal").textContent = "Totaal gescande adressen: " + totaal;

      const tbody = document.querySelector("#resultTable tbody");
      const row = document.createElement("tr");
      row.innerHTML = `<td>${counter}</td><td>${address}</td><td>${wif}</td><td>${saldo}</td>`;
      tbody.appendChild(row);

      while (tbody.rows.length > MAX_VISIBLE) {
        tbody.deleteRow(0);
        counter--;
      }

      // 4) Stop als saldo > 0
      if (typeof saldo === "number" && saldo > 0) {
        row.style.backgroundColor = "#c8f7c5";
        document.getElementById("retryMsg").textContent = 
          `Adres gevonden met saldo > 0 BTC! Adres: ${address}`;
        stoppen();
        return;
      }

      // 5) Volgende adres
      setTimeout(genereer, delay);
    }

    function starten() {
      if (zoeken) return;
      zoeken = true;
      document.getElementById("startBtn").disabled = true;
      document.getElementById("stopBtn").disabled = false;
      document.getElementById("retryMsg").textContent = "";
      genereer();
    }

    function stoppen() {
      zoeken = false;
      document.getElementById("startBtn").disabled = false;
      document.getElementById("stopBtn").disabled = true;
    }

    function resetTeller() {
      totaal = 0;
      localStorage.setItem("totaal", totaal);
      document.getElementById("totaal").textContent = "Totaal gescande adressen: 0";
    }

    document.getElementById("startBtn").addEventListener("click", starten);
    document.getElementById("stopBtn").addEventListener("click", stoppen);
  </script>
</body>
</html>
